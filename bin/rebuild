#!/usr/bin/env bash

BASE_DIR="/etc/nixos"
VERBOSE=false

if [[ "${1}" == "-v" ]]; then
    VERBOSE=true
    shift
fi

log() {
    $VERBOSE && echo ">> ${1}"
}

create_diff() {
    local name="${1}"
    local tag="${2}"

    log "create ${name}-config.diff"
    git -C "${BASE_DIR}/patches/${name}" diff "${tag}" > "${BASE_DIR}/patches/${name}-config.diff"
}

# dmenu
create_diff dmenu 4.8

# dwm
create_diff dwm 6.1

# slock
create_diff slock 1.4

# nixos-rebuild
log "nixos-rebuild"
nixos-rebuild "${1:-test}" ${@:2}

if [[ "${1}" == "build" ]]; then
    echo
    log "nox-update"
    # see https://github.com/madjar/nox/issues/63#issuecomment-303280129
    nox-update --quiet /run/current-system result | \
        grep -v '\.drv : $' | \
        sed 's|^ */nix/store/[a-z0-9]*-||' | \
        sort -u

    rm result
fi

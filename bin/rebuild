#!/usr/bin/env bash

set -e

nixos-rebuild "${1:-test}" ${@:2}

if [[ "${1}" == "build" ]]; then
    echo

    # see https://github.com/madjar/nox/issues/63#issuecomment-303280129
    nox-update --quiet /run/current-system result | \
        grep -v '\.drv : $' | \
        sed 's|^ */nix/store/[a-z0-9]*-||' | \
        sort -u

    rm result
fi

#!/usr/bin/env bash

VERBOSE=false
if [[ "${1}" == "-v" ]]; then
    VERBOSE=true
    shift
fi

log() {
    $VERBOSE && echo ">> ${1}"
}

create_diff() {
    local name="${1}"
    local tag="${2}"

    log "create ${name}-config.diff"
    cd "patches/${name}"
    git diff "${tag}" > "../${name}-config.diff"
    cd - > /dev/null
}

cd /etc/nixos

# dmenu
create_diff dmenu 4.7

# dwm
create_diff dwm 6.1

# slock
create_diff slock 1.4

# set permissions of deploy key
if [[ -e keys/id_rsa.bitbucket-deploy ]]; then
    log "set permissions for bitbucket deploy key"
    chown root:nixbld keys/id_rsa.bitbucket-deploy
    chmod 640 keys/id_rsa.bitbucket-deploy
fi

# nixos-rebuild
log "nixos-rebuild"
nixos-rebuild "${1:-test}" ${@:2}

if [[ "${1}" == "build" ]]; then
    echo
    log "nox-update"
    # see https://github.com/madjar/nox/issues/63#issuecomment-303280129
    nox-update --quiet /run/current-system result | \
        grep -v '\.drv : $' | \
        sed 's|^ */nix/store/[a-z0-9]*-||' | \
        sort -u
fi
